<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>R66PreparedTransferExecutor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Waarp Gateway Ftp</a> &gt; <a href="index.source.html" class="el_package">org.waarp.gateway.ftp.exec</a> &gt; <span class="el_source">R66PreparedTransferExecutor.java</span></div><h1>R66PreparedTransferExecutor.java</h1><pre class="source lang-java linenums">/*
 * This file is part of Waarp Project (named also Waarp or GG).
 *
 *  Copyright (c) 2019, Waarp SAS, and individual contributors by the @author
 *  tags. See the COPYRIGHT.txt in the distribution for a full listing of
 * individual contributors.
 *
 *  All Waarp Project is free software: you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or (at your
 * option) any later version.
 *
 * Waarp is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along with
 * Waarp . If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */


package org.waarp.gateway.ftp.exec;

import org.waarp.common.command.exception.CommandAbstractException;
import org.waarp.common.command.exception.Reply421Exception;
import org.waarp.common.database.DbSession;
import org.waarp.common.database.data.AbstractDbData.UpdatedInfo;
import org.waarp.common.database.exception.WaarpDatabaseException;
import org.waarp.common.future.WaarpFuture;
import org.waarp.common.logging.WaarpLogger;
import org.waarp.common.logging.WaarpLoggerFactory;
import org.waarp.openr66.database.data.DbRule;
import org.waarp.openr66.database.data.DbTaskRunner;
import org.waarp.openr66.protocol.configuration.Configuration;
import org.waarp.openr66.protocol.configuration.PartnerConfiguration;
import org.waarp.openr66.protocol.localhandler.packet.RequestPacket;

import java.io.File;
import java.sql.Timestamp;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Date;

import static org.waarp.common.database.DbConstant.*;

/**
 * R66PreparedTransferExecutor class. If the command starts with &quot;REFUSED&quot;, the
 * command will be refused for
 * execution. If &quot;REFUSED&quot; is set, the command &quot;RETR&quot; or &quot;STOR&quot; like operations
 * will be stopped at starting of
 * command.
 * &lt;p&gt;
 * &lt;p&gt;
 * &lt;p&gt;
 * Format is like r66send command in any order except &quot;-info&quot; which should be
 * the last item:&lt;br&gt;
 * &quot;-to Host -file FILE -rule RULE [-md5] [-nolog] [-start yyyyMMddHHmmss or
 * -delay (delay or +delay)] [-info
 * INFO]&quot; &lt;br&gt;
 * &lt;br&gt;
 * INFO is the only one field that can contains blank character.&lt;br&gt;
 * &lt;br&gt;
 * The following replacement are done dynamically before the command is
 * executed:&lt;br&gt;
 * - #BASEPATH# is replaced by the full path for the root of FTP Directory&lt;br&gt;
 * - #FILE# is replaced by the current file path relative to FTP Directory (so
 * #BASEPATH##FILE# is the full
 * path of the file)&lt;br&gt;
 * - #USER# is replaced by the username&lt;br&gt;
 * - #ACCOUNT# is replaced by the account&lt;br&gt;
 * - #COMMAND# is replaced by the command issued for the file&lt;br&gt;
 * - #SPECIALID# is replaced by the FTP id of the transfer (whatever in or
 * out)&lt;br&gt;
 * - #UUID# is replaced by a special UUID globally unique for the transfer, in
 * general to be placed in -info
 * part (for instance ##UUID## giving #uuid#)&lt;br&gt;
 * &lt;br&gt;
 * So for instance &quot;-to Host -file #BASEPATH##FILE# -rule RULE [-md5] [-nolog]
 * [-delay +delay] [-info ##UUID##
 * #USER# #ACCOUNT# #COMMAND# INFO]&quot; &lt;br&gt;
 * will be a standard use of this function.
 */
public class R66PreparedTransferExecutor extends AbstractExecutor {
  private static final String CANNOT_GET_NEW_TASK = &quot;Cannot get new task\n    &quot;;

  /**
   * Internal Logger
   */
<span class="nc" id="L89">  private static final WaarpLogger logger =</span>
<span class="nc" id="L90">      WaarpLoggerFactory.getLogger(R66PreparedTransferExecutor.class);</span>

  protected final WaarpFuture future;

  protected String filename;

  protected String rulename;

  protected String fileinfo;

  protected boolean isMD5;

  protected boolean nolog;

  protected Timestamp timestart;

  protected String remoteHost;

<span class="nc" id="L108">  protected int blocksize = Configuration.configuration.getBlockSize();</span>

  protected DbSession dbsession;

  /**
   * @param command
   * @param delay
   * @param futureCompletion
   */
  public R66PreparedTransferExecutor(String command, long delay,
<span class="nc" id="L118">                                     WaarpFuture futureCompletion) {</span>
<span class="nc" id="L119">    final String[] args = BLANK.split(command);</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">    for (int i = 0; i &lt; args.length; i++) {</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">      if (&quot;-to&quot;.equalsIgnoreCase(args[i])) {</span>
<span class="nc" id="L122">        i++;</span>
<span class="nc" id="L123">        remoteHost = args[i];</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">        if (Configuration.configuration.getAliases().containsKey(remoteHost)) {</span>
<span class="nc" id="L125">          remoteHost = Configuration.configuration.getAliases().get(remoteHost);</span>
        }
<span class="nc bnc" id="L127" title="All 2 branches missed.">      } else if (&quot;-file&quot;.equalsIgnoreCase(args[i])) {</span>
<span class="nc" id="L128">        i++;</span>
<span class="nc" id="L129">        filename = args[i];</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">      } else if (&quot;-rule&quot;.equalsIgnoreCase(args[i])) {</span>
<span class="nc" id="L131">        i++;</span>
<span class="nc" id="L132">        rulename = args[i];</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">      } else if (&quot;-info&quot;.equalsIgnoreCase(args[i])) {</span>
<span class="nc" id="L134">        i++;</span>
<span class="nc" id="L135">        fileinfo = args[i];</span>
<span class="nc" id="L136">        i++;</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">        while (i &lt; args.length) {</span>
<span class="nc" id="L138">          fileinfo += ' ' + args[i];</span>
<span class="nc" id="L139">          i++;</span>
        }
<span class="nc bnc" id="L141" title="All 2 branches missed.">      } else if (&quot;-md5&quot;.equalsIgnoreCase(args[i])) {</span>
<span class="nc" id="L142">        isMD5 = true;</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">      } else if (&quot;-block&quot;.equalsIgnoreCase(args[i])) {</span>
<span class="nc" id="L144">        i++;</span>
<span class="nc" id="L145">        blocksize = Integer.parseInt(args[i]);</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">        if (blocksize &lt; 100) {</span>
<span class="nc" id="L147">          logger.warn(&quot;Block size is too small: &quot; + blocksize);</span>
<span class="nc" id="L148">          blocksize = Configuration.configuration.getBlockSize();</span>
        }
<span class="nc bnc" id="L150" title="All 2 branches missed.">      } else if (&quot;-nolog&quot;.equalsIgnoreCase(args[i])) {</span>
<span class="nc" id="L151">        nolog = true;</span>
<span class="nc" id="L152">        i++;</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">      } else if (&quot;-start&quot;.equalsIgnoreCase(args[i])) {</span>
<span class="nc" id="L154">        i++;</span>
<span class="nc" id="L155">        final SimpleDateFormat dateFormat =</span>
            new SimpleDateFormat(&quot;yyyyMMddHHmmss&quot;);
        Date date;
        try {
<span class="nc" id="L159">          date = dateFormat.parse(args[i]);</span>
<span class="nc" id="L160">          timestart = new Timestamp(date.getTime());</span>
<span class="nc" id="L161">        } catch (final ParseException ignored) {</span>
          // nothing
<span class="nc" id="L163">        }</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">      } else if (&quot;-delay&quot;.equalsIgnoreCase(args[i])) {</span>
<span class="nc" id="L165">        i++;</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">        if (args[i].charAt(0) == '+') {</span>
<span class="nc" id="L167">          timestart = new Timestamp(System.currentTimeMillis() +</span>
<span class="nc" id="L168">                                    Long.parseLong(args[i].substring(1)));</span>
        } else {
<span class="nc" id="L170">          timestart = new Timestamp(Long.parseLong(args[i]));</span>
        }
      }
    }
<span class="nc bnc" id="L174" title="All 2 branches missed.">    if (fileinfo == null) {</span>
<span class="nc" id="L175">      fileinfo = &quot;noinfo&quot;;</span>
    }
<span class="nc" id="L177">    future = futureCompletion;</span>
<span class="nc" id="L178">  }</span>

  /**
   * @param dbsession the dbsession to set
   */
  public void setDbsession(DbSession dbsession) {
<span class="nc" id="L184">    this.dbsession = dbsession;</span>
<span class="nc" id="L185">  }</span>

  @Override
  public void run() throws CommandAbstractException {
<span class="nc" id="L189">    final String message =</span>
        &quot;R66Prepared with -to &quot; + remoteHost + &quot; -rule &quot; + rulename +
        &quot; -file &quot; + filename + &quot; -nolog: &quot; + nolog + &quot; -isMD5: &quot; + isMD5 +
        &quot; -info &quot; + fileinfo;
<span class="nc bnc" id="L193" title="All 6 branches missed.">    if (remoteHost == null || rulename == null || filename == null) {</span>
<span class="nc" id="L194">      logger.error(</span>
          &quot;Mandatory argument is missing: -to &quot; + remoteHost + &quot; -rule &quot; +
          rulename + &quot; -file &quot; + filename);
<span class="nc" id="L197">      throw new Reply421Exception(</span>
          &quot;Mandatory argument is missing\n    &quot; + message);
    }
<span class="nc" id="L200">    logger.debug(message);</span>
    DbRule rule;
    try {
<span class="nc" id="L203">      rule = new DbRule(rulename);</span>
<span class="nc" id="L204">    } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L205">      logger.error(&quot;Cannot get Rule: &quot; + rulename + &quot; since {}\n    &quot; + message,</span>
<span class="nc" id="L206">                   e.getMessage());</span>
<span class="nc" id="L207">      throw new Reply421Exception(</span>
          &quot;Cannot get Rule: &quot; + rulename + &quot;\n    &quot; + message);
<span class="nc" id="L209">    }</span>
<span class="nc" id="L210">    int mode = rule.getMode();</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">    if (isMD5) {</span>
<span class="nc" id="L212">      mode = RequestPacket.getModeMD5(mode);</span>
    }
<span class="nc" id="L214">    final String sep = PartnerConfiguration.getSeparator(remoteHost);</span>
<span class="nc" id="L215">    long originalSize = -1;</span>
<span class="nc bnc" id="L216" title="All 4 branches missed.">    if (RequestPacket.isSendMode(mode) &amp;&amp; !RequestPacket.isThroughMode(mode)) {</span>
<span class="nc" id="L217">      final File file = new File(filename);</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">      if (file.canRead()) {</span>
<span class="nc" id="L219">        originalSize = file.length();</span>
      }
    }
<span class="nc" id="L222">    final RequestPacket request =</span>
        new RequestPacket(rulename, mode, filename, blocksize, 0, ILLEGALVALUE,
                          fileinfo, originalSize, sep);
    // Not isRecv since it is the requester, so send =&gt; isRetrieve is true
<span class="nc bnc" id="L226" title="All 2 branches missed.">    final boolean isRetrieve = !RequestPacket.isRecvMode(request.getMode());</span>
<span class="nc" id="L227">    logger.debug(&quot;Will prepare: {}&quot;, request);</span>
    DbTaskRunner taskRunner;
    try {
<span class="nc" id="L230">      taskRunner =</span>
          new DbTaskRunner(rule, isRetrieve, request, remoteHost, timestart);
<span class="nc" id="L232">    } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L233">      logger.error(&quot;Cannot get new task since {}\n    &quot; + message,</span>
<span class="nc" id="L234">                   e.getMessage());</span>
<span class="nc" id="L235">      throw new Reply421Exception(CANNOT_GET_NEW_TASK + message);</span>
<span class="nc" id="L236">    }</span>
<span class="nc" id="L237">    taskRunner.changeUpdatedInfo(UpdatedInfo.TOSUBMIT);</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">    if (!taskRunner.forceSaveStatus()) {</span>
      try {
<span class="nc bnc" id="L240" title="All 2 branches missed.">        if (!taskRunner.specialSubmit()) {</span>
<span class="nc" id="L241">          logger.error(&quot;Cannot prepare task: &quot; + message);</span>
<span class="nc" id="L242">          throw new Reply421Exception(CANNOT_GET_NEW_TASK + message);</span>
        }
<span class="nc" id="L244">      } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L245">        logger.error(&quot;Cannot prepare task since {}\n    &quot; + message,</span>
<span class="nc" id="L246">                     e.getMessage());</span>
<span class="nc" id="L247">        throw new Reply421Exception(CANNOT_GET_NEW_TASK + message);</span>
<span class="nc" id="L248">      }</span>
    }
<span class="nc" id="L250">    logger.debug(&quot;R66PreparedTransfer prepared: {}&quot;, request);</span>
<span class="nc" id="L251">    future.setSuccess();</span>
<span class="nc" id="L252">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>