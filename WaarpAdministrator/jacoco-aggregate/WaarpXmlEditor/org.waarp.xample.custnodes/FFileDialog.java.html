<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>FFileDialog.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Waarp Administrator</a> &gt; <a href="../index.html" class="el_bundle">WaarpXmlEditor</a> &gt; <a href="index.source.html" class="el_package">org.waarp.xample.custnodes</a> &gt; <span class="el_source">FFileDialog.java</span></div><h1>FFileDialog.java</h1><pre class="source lang-java linenums">/*
 * This file is part of Waarp Project (named also Waarp or GG).
 *
 *  Copyright (c) 2019, Waarp SAS, and individual contributors by the @author
 *  tags. See the COPYRIGHT.txt in the distribution for a full listing of
 * individual contributors.
 *
 *  All Waarp Project is free software: you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or (at your
 * option) any later version.
 *
 * Waarp is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along with
 * Waarp . If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.waarp.xample.custnodes;

import com.fg.ftreenodes.ICellControl;
import com.fg.ftreenodes.Params;

import javax.swing.JButton;
import javax.swing.JDialog;
import javax.swing.JFileChooser;
import javax.swing.JPanel;
import javax.swing.filechooser.FileFilter;
import java.awt.BorderLayout;
import java.awt.Component;
import java.awt.Container;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.WindowEvent;
import java.io.File;
import java.util.HashSet;
import java.util.List;
import java.util.StringTokenizer;

/*
 * Copyright (c) 2003 Felix Golubov
 */

/**
 * FFileDialog is a file dialog, which can be used as a custom field editor for
 * the
 * {@link com.fg.xmleditor.FXBasicView}. Since FFileDialog is a JDialog, it can
 * be used as both custom field
 * editor and a global editor.
 *
 * @author Felix Golubov
 * @version 2.0
 *     &lt;p&gt;
 *     Add support for Directory and different options on File Dialog
 */

/*
 * Implementation notices: Well, it would much better to make buttons of the JFileChooser invisible and create
 * our own &quot;OK&quot; and &quot;Cancel&quot; buttons. The problem is that CDE/Motif UI doesn't allow to make buttons
 * invisible. Hence all the complexities with addBtnListener(Component c) recursive method. Besides, when UI
 * changes, all the child components of the JFileChooser are discarded, so addBtnListener has to be called
 * from the updateUI() method.
 */

public class FFileDialog extends JDialog
    implements ICellControl, ActionListener {
  /**
   *
   */
  private static final long serialVersionUID = -8775488630211100329L;
<span class="nc" id="L72">  JPanel panel = new JPanel();</span>
<span class="nc" id="L73">  final FFileChooser fileChooser = new FFileChooser();</span>
<span class="nc" id="L74">  int mode = JFileChooser.FILES_ONLY;</span>
  transient Object data;
  transient List masks;

<span class="nc" id="L78">  public FFileDialog() {</span>
<span class="nc" id="L79">    getContentPane().setLayout(new BorderLayout());</span>
<span class="nc" id="L80">    fileChooser.setCurrentDirectory(new File(&quot;.&quot;));</span>
<span class="nc" id="L81">    fileChooser.addActionListener(this);</span>
<span class="nc" id="L82">    fileChooser.setApproveButtonText(&quot;OK&quot;);</span>
<span class="nc" id="L83">    getContentPane().add(fileChooser, BorderLayout.CENTER);</span>
<span class="nc" id="L84">  }</span>

  @Override
  protected void processWindowEvent(WindowEvent e) {
<span class="nc bnc" id="L88" title="All 2 branches missed.">    if (e.getID() == WindowEvent.WINDOW_CLOSING) {</span>
<span class="nc" id="L89">      cancel();</span>
    }
<span class="nc" id="L91">    super.processWindowEvent(e);</span>
<span class="nc" id="L92">  }</span>

  void cancel() {
<span class="nc" id="L95">    dispose();</span>
<span class="nc" id="L96">  }</span>

  @Override
  public void actionPerformed(ActionEvent e) {
<span class="nc bnc" id="L100" title="All 2 branches missed.">    if (!(e.getSource() instanceof JButton)) {</span>
<span class="nc" id="L101">      return;</span>
    }
<span class="nc" id="L103">    final JButton btn = (JButton) e.getSource();</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">    if (&quot;OK&quot;.equals(btn.getText())) {</span>
<span class="nc" id="L105">      final File file = fileChooser.getSelectedFile();</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">      data = file == null? &quot;&quot; : file.getAbsolutePath();</span>
<span class="nc" id="L107">      cancel();</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">    } else if (&quot;Cancel&quot;.equals(btn.getText())) {</span>
<span class="nc" id="L109">      cancel();</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">    } else if (&quot;Annuler&quot;.equals(btn.getText())) {</span>
<span class="nc" id="L111">      cancel();</span>
    }
<span class="nc" id="L113">  }</span>

  @Override
  public void initCellControl(boolean isEditor) {
<span class="nc" id="L117">    fileChooser.addBtnListener(fileChooser);</span>
<span class="nc" id="L118">  }</span>

  @Override
  public void updateCellControl(boolean isEditor, boolean enabled,
                                boolean editable, Object data, Params params) {
<span class="nc" id="L123">    pack();</span>
<span class="nc" id="L124">    this.data = data;</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">    if (data != null) {</span>
<span class="nc" id="L126">      final String path = data.toString().trim();</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">      if (path.length() &gt; 0) {</span>
        try {
<span class="nc" id="L129">          final File file = new File(path);</span>
<span class="nc" id="L130">          fileChooser.setSelectedFile(file);</span>
<span class="nc" id="L131">        } catch (final Exception ex) {</span>
<span class="nc" id="L132">          fileChooser.setSelectedFile(null);</span>
<span class="nc" id="L133">        }</span>
      } else {
<span class="nc" id="L135">        fileChooser.setSelectedFile(null);</span>
      }
<span class="nc" id="L137">    } else {</span>
<span class="nc" id="L138">      fileChooser.setSelectedFile(null);</span>
    }
<span class="nc" id="L140">    final List list = params.getList();</span>
<span class="nc" id="L141">    boolean sameMasks = true;</span>
<span class="nc bnc" id="L142" title="All 4 branches missed.">    if (masks == null || list.size() != masks.size()) {</span>
<span class="nc" id="L143">      sameMasks = false;</span>
    } else {
<span class="nc bnc" id="L145" title="All 4 branches missed.">      for (int i = 0; i &lt; list.size() &amp;&amp; sameMasks; i++) {</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">        if (!list.get(i).equals(masks.get(i))) {</span>
<span class="nc" id="L147">          sameMasks = false;</span>
<span class="nc" id="L148">          break;</span>
        }
      }
    }
<span class="nc bnc" id="L152" title="All 2 branches missed.">    if (sameMasks) {</span>
<span class="nc" id="L153">      return;</span>
    }
<span class="nc" id="L155">    masks = list;</span>
<span class="nc" id="L156">    fileChooser.resetChoosableFileFilters();</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">    for (int i = 0; i &lt; masks.size(); i++) {</span>
<span class="nc" id="L158">      fileChooser</span>
<span class="nc" id="L159">          .addChoosableFileFilter(new FileExtFilter((String) masks.get(i)));</span>
    }
<span class="nc" id="L161">  }</span>

  @Override
  public Object getData() {
<span class="nc" id="L165">    return data;</span>
  }

  class FileExtFilter extends FileFilter {
<span class="nc" id="L169">    final HashSet&lt;String&gt; extensions = new HashSet&lt;String&gt;();</span>
<span class="nc" id="L170">    String description = &quot;&quot;;</span>

<span class="nc" id="L172">    FileExtFilter(String mask) {</span>
<span class="nc" id="L173">      final StringTokenizer st = new StringTokenizer(mask, &quot;|&quot;);</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">      while (st.hasMoreElements()) {</span>
<span class="nc" id="L175">        String token = st.nextToken().trim();</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">        if (st.hasMoreElements()) {</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">          if (token.length() == 0) {</span>
            // no extension
          } else {
<span class="nc bnc" id="L180" title="All 2 branches missed.">            if (token.startsWith(&quot;null&quot;)) {</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">              if (token.length() &gt; 4) {</span>
<span class="nc" id="L182">                token = token.substring(5).trim();</span>
              } else {
<span class="nc" id="L184">                token = &quot;&quot;;</span>
              }
            }
<span class="nc bnc" id="L187" title="All 2 branches missed.">            if (token.length() &gt; 0) {</span>
<span class="nc" id="L188">              extensions.add(token.toLowerCase());</span>
            }
          }
        } else {
<span class="nc" id="L192">          final String type = token.substring(0, 1);</span>
<span class="nc" id="L193">          final int val = Integer.parseInt(type);</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">          if (val == 0) {</span>
<span class="nc" id="L195">            mode = JFileChooser.FILES_ONLY;</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">          } else if (val == 1) {</span>
<span class="nc" id="L197">            mode = JFileChooser.DIRECTORIES_ONLY;</span>
          } else {
<span class="nc" id="L199">            mode = JFileChooser.FILES_AND_DIRECTORIES;</span>
          }
<span class="nc" id="L201">          description = token.substring(1);</span>
        }
<span class="nc" id="L203">      }</span>
<span class="nc" id="L204">      fileChooser.setFileSelectionMode(mode);</span>
<span class="nc" id="L205">    }</span>

    @Override
    public boolean accept(File f) {
<span class="nc bnc" id="L209" title="All 2 branches missed.">      if (f.isDirectory()) {</span>
<span class="nc" id="L210">        return true;</span>
      }
<span class="nc bnc" id="L212" title="All 4 branches missed.">      if (f.isFile() &amp;&amp; mode == JFileChooser.DIRECTORIES_ONLY) {</span>
<span class="nc" id="L213">        return false;</span>
      }
<span class="nc bnc" id="L215" title="All 2 branches missed.">      if (extensions.isEmpty()) {</span>
<span class="nc" id="L216">        return true;</span>
      }
      String ext;
<span class="nc" id="L219">      final String name = f.getName();</span>
<span class="nc" id="L220">      final int i = name.lastIndexOf('.');</span>
<span class="nc bnc" id="L221" title="All 4 branches missed.">      if (i &gt; 0 &amp;&amp; i &lt; name.length() - 1) {</span>
<span class="nc" id="L222">        ext = name.substring(i + 1).toLowerCase();</span>
<span class="nc" id="L223">        return extensions.contains(ext);</span>
      } else {
<span class="nc" id="L225">        return false;</span>
      }
    }

    @Override
    public String getDescription() {
<span class="nc" id="L231">      return description;</span>
    }
  }

<span class="nc" id="L235">  class FFileChooser extends JFileChooser {</span>
    /**
     *
     */
    private static final long serialVersionUID = -4161876854413783100L;

    public void addBtnListener(Component c) {
<span class="nc bnc" id="L242" title="All 2 branches missed.">      if (c instanceof JButton) {</span>
<span class="nc" id="L243">        ((JButton) c).addActionListener(FFileDialog.this);</span>
      }
<span class="nc bnc" id="L245" title="All 2 branches missed.">      if (c instanceof Container) {</span>
<span class="nc" id="L246">        final Component[] children = ((Container) c).getComponents();</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">        for (final Component element : children) {</span>
<span class="nc" id="L248">          addBtnListener(element);</span>
        }
      }
<span class="nc" id="L251">    }</span>

    @Override
    public void updateUI() {
<span class="nc bnc" id="L255" title="All 2 branches missed.">      setAcceptAllFileFilterUsed(getAcceptAllFileFilter() == null);</span>
<span class="nc" id="L256">      super.updateUI();</span>
<span class="nc" id="L257">      setAcceptAllFileFilterUsed(true);</span>
<span class="nc" id="L258">      addBtnListener(this);</span>
<span class="nc" id="L259">    }</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>