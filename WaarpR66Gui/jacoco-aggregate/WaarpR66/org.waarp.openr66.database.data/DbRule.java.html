<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>DbRule.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Waarp R66 Client Gui</a> &gt; <a href="../index.html" class="el_bundle">WaarpR66</a> &gt; <a href="index.source.html" class="el_package">org.waarp.openr66.database.data</a> &gt; <span class="el_source">DbRule.java</span></div><h1>DbRule.java</h1><pre class="source lang-java linenums">/*
 * This file is part of Waarp Project (named also Waarp or GG).
 *
 *  Copyright (c) 2019, Waarp SAS, and individual contributors by the @author
 *  tags. See the COPYRIGHT.txt in the distribution for a full listing of
 * individual contributors.
 *
 *  All Waarp Project is free software: you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or (at your
 * option) any later version.
 *
 * Waarp is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along with
 * Waarp . If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.waarp.openr66.database.data;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.node.ArrayNode;
import com.fasterxml.jackson.databind.node.ObjectNode;
import org.dom4j.Document;
import org.dom4j.DocumentException;
import org.dom4j.io.SAXReader;
import org.waarp.common.database.DbPreparedStatement;
import org.waarp.common.database.DbSession;
import org.waarp.common.database.exception.WaarpDatabaseException;
import org.waarp.common.database.exception.WaarpDatabaseNoConnectionException;
import org.waarp.common.database.exception.WaarpDatabaseNoDataException;
import org.waarp.common.database.exception.WaarpDatabaseSqlException;
import org.waarp.common.file.DirInterface;
import org.waarp.common.file.FileUtils;
import org.waarp.common.json.JsonHandler;
import org.waarp.common.logging.WaarpLogger;
import org.waarp.common.logging.WaarpLoggerFactory;
import org.waarp.common.utility.WaarpStringUtils;
import org.waarp.common.xml.XmlUtil;
import org.waarp.common.xml.XmlValue;
import org.waarp.openr66.configuration.RuleFileBasedConfiguration;
import org.waarp.openr66.context.R66Session;
import org.waarp.openr66.dao.AbstractDAO;
import org.waarp.openr66.dao.DAOFactory;
import org.waarp.openr66.dao.Filter;
import org.waarp.openr66.dao.RuleDAO;
import org.waarp.openr66.dao.database.DBRuleDAO;
import org.waarp.openr66.dao.database.StatementExecutor;
import org.waarp.openr66.dao.exception.DAOConnectionException;
import org.waarp.openr66.dao.exception.DAONoDataException;
import org.waarp.openr66.database.data.DbTaskRunner.TASKSTEP;
import org.waarp.openr66.pojo.Rule;
import org.waarp.openr66.pojo.RuleTask;
import org.waarp.openr66.pojo.Transfer;
import org.waarp.openr66.protocol.configuration.Configuration;
import org.waarp.openr66.protocol.exception.OpenR66ProtocolBusinessException;
import org.waarp.openr66.protocol.exception.OpenR66ProtocolSystemException;
import org.waarp.openr66.protocol.localhandler.packet.RequestPacket;

import java.io.File;
import java.io.StringReader;
import java.sql.SQLException;
import java.sql.Types;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

/**
 * Rule Table object
 */
public class DbRule extends AbstractDbDataDao&lt;Rule&gt; {
  private static final String RULE_NOT_FOUND = &quot;Rule not found&quot;;
  /**
   * Internal Logger
   */
<span class="nc" id="L77">  private static final WaarpLogger logger =</span>
<span class="nc" id="L78">      WaarpLoggerFactory.getLogger(DbRule.class);</span>
<span class="nc" id="L79">  private static final String[] STRING_0_LENGTH = new String[0];</span>
<span class="nc" id="L80">  private static final String[][] STRINGS_0_0_LENGTH = new String[0][0];</span>

<span class="nc" id="L82">  public enum Columns {</span>
<span class="nc" id="L83">    HOSTIDS, MODETRANS, RECVPATH, SENDPATH, ARCHIVEPATH, WORKPATH, RPRETASKS,</span>
<span class="nc" id="L84">    RPOSTTASKS, RERRORTASKS, SPRETASKS, SPOSTTASKS, SERRORTASKS, UPDATEDINFO,</span>
<span class="nc" id="L85">    IDRULE</span>
  }

<span class="nc" id="L88">  public static final int[] dbTypes = {</span>
      Types.LONGVARCHAR, Types.INTEGER, Types.NVARCHAR, Types.NVARCHAR,
      Types.NVARCHAR, Types.NVARCHAR, Types.LONGVARCHAR, Types.LONGVARCHAR,
      Types.LONGVARCHAR, Types.LONGVARCHAR, Types.LONGVARCHAR,
      Types.LONGVARCHAR, Types.INTEGER, Types.NVARCHAR
  };

  public static final String table = &quot; RULES &quot;;

  /**
   * Internal context XML fields
   */
  public static final String TASK_TYPE = &quot;type&quot;;

  /**
   * Internal context XML fields
   */
  public static final String TASK_PATH = &quot;path&quot;;

  /**
   * Internal context XML fields
   */
  public static final String TASK_DELAY = &quot;delay&quot;;
  /**
   * Internal context XML fields
   */
  public static final String TASK_COMMENT = &quot;comment&quot;;

  // ALL TABLE SHOULD IMPLEMENT THIS
  public static final int NBPRKEY = 1;

<span class="nc" id="L119">  protected static final String selectAllFields =</span>
<span class="nc" id="L120">      Columns.HOSTIDS.name() + ',' + Columns.MODETRANS.name() + ',' +</span>
<span class="nc" id="L121">      Columns.RECVPATH.name() + ',' + Columns.SENDPATH.name() + ',' +</span>
<span class="nc" id="L122">      Columns.ARCHIVEPATH.name() + ',' + Columns.WORKPATH.name() + ',' +</span>
<span class="nc" id="L123">      Columns.RPRETASKS.name() + ',' + Columns.RPOSTTASKS.name() + ',' +</span>
<span class="nc" id="L124">      Columns.RERRORTASKS.name() + ',' + Columns.SPRETASKS.name() + ',' +</span>
<span class="nc" id="L125">      Columns.SPOSTTASKS.name() + ',' + Columns.SERRORTASKS.name() + ',' +</span>
<span class="nc" id="L126">      Columns.UPDATEDINFO.name() + ',' + Columns.IDRULE.name();</span>

<span class="nc" id="L128">  protected static final String updateAllFields =</span>
<span class="nc" id="L129">      Columns.HOSTIDS.name() + &quot;=?,&quot; + Columns.MODETRANS.name() + &quot;=?,&quot; +</span>
<span class="nc" id="L130">      Columns.RECVPATH.name() + &quot;=?,&quot; + Columns.SENDPATH.name() + &quot;=?,&quot; +</span>
<span class="nc" id="L131">      Columns.ARCHIVEPATH.name() + &quot;=?,&quot; + Columns.WORKPATH.name() + &quot;=?,&quot; +</span>
<span class="nc" id="L132">      Columns.RPRETASKS.name() + &quot;=?,&quot; + Columns.RPOSTTASKS.name() + &quot;=?,&quot; +</span>
<span class="nc" id="L133">      Columns.RERRORTASKS.name() + &quot;=?,&quot; + Columns.SPRETASKS.name() + &quot;=?,&quot; +</span>
<span class="nc" id="L134">      Columns.SPOSTTASKS.name() + &quot;=?,&quot; + Columns.SERRORTASKS.name() + &quot;=?,&quot; +</span>
<span class="nc" id="L135">      Columns.UPDATEDINFO.name() + &quot;=?&quot;;</span>

  protected static final String insertAllValues =
      &quot; (?,?,?,?,?,?,?,?,?,?,?,?,?,?) &quot;;

  @Override
  protected void initObject() {
    // Nothing
<span class="nc" id="L143">  }</span>

  @Override
  protected String getTable() {
<span class="nc" id="L147">    return table;</span>
  }

  @Override
  protected AbstractDAO&lt;Rule&gt; getDao() throws DAOConnectionException {
<span class="nc" id="L152">    return DAOFactory.getInstance().getRuleDAO();</span>
  }

  @Override
  protected String getPrimaryKey() {
<span class="nc bnc" id="L157" title="All 2 branches missed.">    if (pojo != null) {</span>
<span class="nc" id="L158">      return pojo.getName();</span>
    }
<span class="nc" id="L160">    throw new IllegalArgumentException(&quot;pojo is null&quot;);</span>
  }

  @Override
  protected String getPrimaryField() {
<span class="nc" id="L165">    return Columns.IDRULE.name();</span>
  }

  protected final void checkPath() {
<span class="nc bnc" id="L169" title="All 4 branches missed.">    if (getRecvPath() != null &amp;&amp; !getRecvPath().isEmpty() &amp;&amp;</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">        getRecvPath().charAt(0) != DirInterface.SEPARATORCHAR) {</span>
<span class="nc" id="L171">      pojo.setRecvPath(DirInterface.SEPARATOR + getRecvPath());</span>
    }
<span class="nc bnc" id="L173" title="All 4 branches missed.">    if (getSendPath() != null &amp;&amp; !getSendPath().isEmpty() &amp;&amp;</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">        getSendPath().charAt(0) != DirInterface.SEPARATORCHAR) {</span>
<span class="nc" id="L175">      pojo.setSendPath(DirInterface.SEPARATOR + getSendPath());</span>
    }
<span class="nc bnc" id="L177" title="All 4 branches missed.">    if (getArchivePath() != null &amp;&amp; !getArchivePath().isEmpty() &amp;&amp;</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">        getArchivePath().charAt(0) != DirInterface.SEPARATORCHAR) {</span>
<span class="nc" id="L179">      pojo.setArchivePath(DirInterface.SEPARATOR + getArchivePath());</span>
    }
<span class="nc bnc" id="L181" title="All 4 branches missed.">    if (getWorkPath() != null &amp;&amp; !getWorkPath().isEmpty() &amp;&amp;</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">        getWorkPath().charAt(0) != DirInterface.SEPARATORCHAR) {</span>
<span class="nc" id="L183">      pojo.setWorkPath(DirInterface.SEPARATOR + getWorkPath());</span>
    }
<span class="nc" id="L185">  }</span>

  /**
   * @param idRule
   * @param ids
   * @param mode
   * @param recvPath
   * @param sendPath
   * @param archivePath
   * @param workPath
   * @param rpreTasks
   * @param rpostTasks
   * @param rerrorTasks
   * @param spreTasks
   * @param spostTasks
   * @param serrorTasks
   */
  public DbRule(String idRule, String ids, int mode, String recvPath,
                String sendPath, String archivePath, String workPath,
                String rpreTasks, String rpostTasks, String rerrorTasks,
<span class="nc" id="L205">                String spreTasks, String spostTasks, String serrorTasks) {</span>
<span class="nc" id="L206">    pojo = new Rule(idRule, mode, Arrays.asList(getIdsRule(ids)), recvPath,</span>
                    sendPath, archivePath, workPath,
<span class="nc" id="L208">                    fromLegacyTasks(getTasksRule(rpreTasks)),</span>
<span class="nc" id="L209">                    fromLegacyTasks(getTasksRule(rpostTasks)),</span>
<span class="nc" id="L210">                    fromLegacyTasks(getTasksRule(rerrorTasks)),</span>
<span class="nc" id="L211">                    fromLegacyTasks(getTasksRule(spreTasks)),</span>
<span class="nc" id="L212">                    fromLegacyTasks(getTasksRule(spostTasks)),</span>
<span class="nc" id="L213">                    fromLegacyTasks(getTasksRule(serrorTasks)));</span>
<span class="nc" id="L214">    checkPath();</span>
<span class="nc" id="L215">  }</span>

  /**
   * @param idRule
   *
   * @throws WaarpDatabaseException
   */
<span class="nc" id="L222">  public DbRule(String idRule) throws WaarpDatabaseException {</span>
<span class="nc" id="L223">    RuleDAO ruleAccess = null;</span>
    try {
<span class="nc" id="L225">      ruleAccess = DAOFactory.getInstance().getRuleDAO();</span>
<span class="nc" id="L226">      pojo = ruleAccess.select(idRule);</span>
<span class="nc" id="L227">    } catch (final DAOConnectionException e) {</span>
<span class="nc" id="L228">      throw new WaarpDatabaseException(e);</span>
<span class="nc" id="L229">    } catch (final DAONoDataException e) {</span>
<span class="nc" id="L230">      throw new WaarpDatabaseNoDataException(RULE_NOT_FOUND + &quot; &quot; + idRule, e);</span>
    } finally {
<span class="nc" id="L232">      DAOFactory.closeDAO(ruleAccess);</span>
    }
<span class="nc" id="L234">    checkPath();</span>
<span class="nc" id="L235">  }</span>

<span class="nc" id="L237">  public DbRule(Rule rule) {</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">    if (rule == null) {</span>
<span class="nc" id="L239">      throw new IllegalArgumentException(</span>
          &quot;Argument in constructor cannot be null&quot;);
    }
<span class="nc" id="L242">    this.pojo = rule;</span>
<span class="nc" id="L243">    checkPath();</span>
<span class="nc" id="L244">  }</span>

  /**
   * Constructor used from XML file
   *
   * @param idrule
   * @param idsArrayRef
   * @param recvpath
   * @param sendpath
   * @param archivepath
   * @param workpath
   * @param rpretasksArray
   * @param rposttasksArray
   * @param rerrortasksArray
   * @param spretasksArray
   * @param sposttasksArray
   * @param serrortasksArray
   */
  public DbRule(String idrule, String[] idsArrayRef, int mode, String recvpath,
                String sendpath, String archivepath, String workpath,
                String[][] rpretasksArray, String[][] rposttasksArray,
                String[][] rerrortasksArray, String[][] spretasksArray,
<span class="nc" id="L266">                String[][] sposttasksArray, String[][] serrortasksArray) {</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">    if (idsArrayRef == null) {</span>
<span class="nc" id="L268">      idsArrayRef = STRING_0_LENGTH;</span>
    }
<span class="nc" id="L270">    pojo =</span>
<span class="nc" id="L271">        new Rule(idrule, mode, Arrays.asList(idsArrayRef), recvpath, sendpath,</span>
<span class="nc" id="L272">                 archivepath, workpath, fromLegacyTasks(rpretasksArray),</span>
<span class="nc" id="L273">                 fromLegacyTasks(rposttasksArray),</span>
<span class="nc" id="L274">                 fromLegacyTasks(rerrortasksArray),</span>
<span class="nc" id="L275">                 fromLegacyTasks(spretasksArray),</span>
<span class="nc" id="L276">                 fromLegacyTasks(sposttasksArray),</span>
<span class="nc" id="L277">                 fromLegacyTasks(serrortasksArray));</span>
<span class="nc" id="L278">    checkPath();</span>
<span class="nc" id="L279">  }</span>

  /**
   * Constructor from Json
   *
   * @param source
   *
   * @throws WaarpDatabaseSqlException
   */
<span class="nc" id="L288">  public DbRule(ObjectNode source) throws WaarpDatabaseSqlException {</span>
<span class="nc" id="L289">    pojo = new Rule();</span>
<span class="nc" id="L290">    setFromJson(source, false);</span>
<span class="nc bnc" id="L291" title="All 4 branches missed.">    if (getIdRule() == null || getIdRule().isEmpty()) {</span>
<span class="nc" id="L292">      throw new WaarpDatabaseSqlException(</span>
          &quot;Not enough argument to create the object&quot;);
    }
<span class="nc" id="L295">    checkPath();</span>
<span class="nc" id="L296">  }</span>

  @Override
  public void setFromJson(ObjectNode node, boolean ignorePrimaryKey)
      throws WaarpDatabaseSqlException {
<span class="nc" id="L301">    super.setFromJson(node, ignorePrimaryKey);</span>
<span class="nc" id="L302">    checkPath();</span>
<span class="nc" id="L303">  }</span>

  @Override
  protected void setFromJson(final String field, final JsonNode value) {
<span class="nc bnc" id="L307" title="All 2 branches missed.">    if (value == null) {</span>
<span class="nc" id="L308">      return;</span>
    }
<span class="nc bnc" id="L310" title="All 2 branches missed.">    for (Columns column : Columns.values()) {</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">      if (column.name().equalsIgnoreCase(field)) {</span>
<span class="nc bnc" id="L312" title="All 15 branches missed.">        switch (column) {</span>
          case ARCHIVEPATH:
<span class="nc" id="L314">            pojo.setArchivePath(value.asText());</span>
<span class="nc" id="L315">            break;</span>
          case HOSTIDS:
<span class="nc" id="L317">            pojo.setHostids(Arrays.asList(getIdsRule(value.asText())));</span>
<span class="nc" id="L318">            break;</span>
          case IDRULE:
<span class="nc" id="L320">            pojo.setName(value.asText());</span>
<span class="nc" id="L321">            break;</span>
          case MODETRANS:
<span class="nc" id="L323">            pojo.setMode(value.asInt());</span>
<span class="nc" id="L324">            break;</span>
          case RECVPATH:
<span class="nc" id="L326">            pojo.setRecvPath(value.asText());</span>
<span class="nc" id="L327">            break;</span>
          case RERRORTASKS:
<span class="nc" id="L329">            pojo.setRErrorTasks(fromLegacyTasks(getTasksRule(value.asText())));</span>
<span class="nc" id="L330">            break;</span>
          case RPOSTTASKS:
<span class="nc" id="L332">            pojo.setRPostTasks(fromLegacyTasks(getTasksRule(value.asText())));</span>
<span class="nc" id="L333">            break;</span>
          case RPRETASKS:
<span class="nc" id="L335">            pojo.setRPreTasks(fromLegacyTasks(getTasksRule(value.asText())));</span>
<span class="nc" id="L336">            break;</span>
          case SENDPATH:
<span class="nc" id="L338">            pojo.setSendPath(value.asText());</span>
<span class="nc" id="L339">            break;</span>
          case SERRORTASKS:
<span class="nc" id="L341">            pojo.setSErrorTasks(fromLegacyTasks(getTasksRule(value.asText())));</span>
<span class="nc" id="L342">            break;</span>
          case SPOSTTASKS:
<span class="nc" id="L344">            pojo.setSPostTasks(fromLegacyTasks(getTasksRule(value.asText())));</span>
<span class="nc" id="L345">            break;</span>
          case SPRETASKS:
<span class="nc" id="L347">            pojo.setSPreTasks(fromLegacyTasks(getTasksRule(value.asText())));</span>
<span class="nc" id="L348">            break;</span>
          case WORKPATH:
<span class="nc" id="L350">            pojo.setWorkPath(value.asText());</span>
<span class="nc" id="L351">            break;</span>
          case UPDATEDINFO:
<span class="nc" id="L353">            pojo.setUpdatedInfo(</span>
<span class="nc" id="L354">                org.waarp.openr66.pojo.UpdatedInfo.valueOf(value.asInt()));</span>
            break;
        }
      }
    }
<span class="nc" id="L359">    checkPath();</span>
<span class="nc" id="L360">  }</span>

  /**
   * Private constructor for Commander only
   */
<span class="nc" id="L365">  private DbRule() {</span>
<span class="nc" id="L366">    pojo = new Rule();</span>
<span class="nc" id="L367">  }</span>

  /**
   * Delete object from table DbRule only if no DbTaskRunner is using it.
   *
   * @throws WaarpDatabaseException
   */
  @Override
  public void delete() throws WaarpDatabaseException {
<span class="nc" id="L376">    AbstractDAO&lt;Transfer&gt; transferDAO = null;</span>
    try {
<span class="nc" id="L378">      transferDAO = DAOFactory.getInstance().getTransferDAO();</span>
<span class="nc" id="L379">      List&lt;Filter&gt; filters = new ArrayList&lt;Filter&gt;();</span>
<span class="nc" id="L380">      Filter filter =</span>
<span class="nc" id="L381">          new Filter(DbTaskRunner.Columns.IDRULE.name(), &quot;=&quot;, this.getIdRule());</span>
<span class="nc" id="L382">      filters.add(filter);</span>
<span class="nc" id="L383">      List&lt;Transfer&gt; transfers = transferDAO.find(filters);</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">      if (!transfers.isEmpty()) {</span>
<span class="nc" id="L385">        transfers.clear();</span>
<span class="nc" id="L386">        throw new WaarpDatabaseNoDataException(&quot;Rule &quot; + this.getIdRule() +</span>
                                               &quot; is still used by TaskRunner therefore it cannot be deleted.&quot;);
      }
<span class="nc" id="L389">    } catch (DAOConnectionException e) {</span>
<span class="nc" id="L390">      throw new WaarpDatabaseNoConnectionException(e);</span>
    } finally {
<span class="nc bnc" id="L392" title="All 2 branches missed.">      if (transferDAO != null) {</span>
<span class="nc" id="L393">        transferDAO.close();</span>
      }
    }
<span class="nc" id="L396">    super.delete();</span>
<span class="nc" id="L397">  }</span>

  /**
   * Delete all Rules but returns original one, therefore not checking if
   * any TaskRunner are using it (used by reloading rules)
   *
   * @return the previously existing DbRule
   *
   * @throws WaarpDatabaseException
   */
  public static DbRule[] deleteAll() throws WaarpDatabaseException {
<span class="nc" id="L408">    RuleDAO ruleAccess = null;</span>
    List&lt;Rule&gt; rules;
    try {
<span class="nc" id="L411">      ruleAccess = DAOFactory.getInstance().getRuleDAO();</span>
<span class="nc" id="L412">      rules = ruleAccess.getAll();</span>
<span class="nc" id="L413">      ruleAccess.deleteAll();</span>
<span class="nc" id="L414">    } catch (final DAOConnectionException e) {</span>
<span class="nc" id="L415">      throw new WaarpDatabaseException(e);</span>
    } finally {
<span class="nc" id="L417">      DAOFactory.closeDAO(ruleAccess);</span>
    }
<span class="nc" id="L419">    final DbRule[] res = new DbRule[rules.size()];</span>
<span class="nc" id="L420">    int i = 0;</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">    for (final Rule rule : rules) {</span>
<span class="nc" id="L422">      res[i] = new DbRule(rule);</span>
<span class="nc" id="L423">      i++;</span>
<span class="nc" id="L424">    }</span>
<span class="nc" id="L425">    return res;</span>
  }

  /**
   * Get All DbRule from database or from internal hashMap in case of no
   * database support
   *
   * @return the array of DbRule
   *
   * @throws WaarpDatabaseNoConnectionException
   * @throws WaarpDatabaseSqlException
   */
  public static DbRule[] getAllRules()
      throws WaarpDatabaseNoConnectionException {
<span class="nc" id="L439">    RuleDAO ruleAccess = null;</span>
    List&lt;Rule&gt; rules;
    try {
<span class="nc" id="L442">      ruleAccess = DAOFactory.getInstance().getRuleDAO();</span>
<span class="nc" id="L443">      rules = ruleAccess.getAll();</span>
<span class="nc" id="L444">    } catch (final DAOConnectionException e) {</span>
<span class="nc" id="L445">      throw new WaarpDatabaseNoConnectionException(e);</span>
    } finally {
<span class="nc" id="L447">      DAOFactory.closeDAO(ruleAccess);</span>
    }
<span class="nc" id="L449">    final DbRule[] res = new DbRule[rules.size()];</span>
<span class="nc" id="L450">    int i = 0;</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">    for (final Rule rule : rules) {</span>
<span class="nc" id="L452">      res[i] = new DbRule(rule);</span>
<span class="nc" id="L453">      i++;</span>
<span class="nc" id="L454">    }</span>
<span class="nc" id="L455">    return res;</span>
  }

  /**
   * For instance from Commander when getting updated information
   *
   * @param preparedStatement
   *
   * @return the next updated DbRule
   *
   * @throws WaarpDatabaseNoConnectionException
   * @throws WaarpDatabaseSqlException
   */
  public static DbRule getFromStatement(DbPreparedStatement preparedStatement)
      throws WaarpDatabaseNoConnectionException, WaarpDatabaseSqlException {
<span class="nc" id="L470">    final DbRule dbRule = new DbRule();</span>
<span class="nc" id="L471">    AbstractDAO&lt;Rule&gt; ruleDAO = null;</span>
    try {
<span class="nc" id="L473">      ruleDAO = dbRule.getDao();</span>
<span class="nc" id="L474">      dbRule.pojo = ((StatementExecutor&lt;Rule&gt;) ruleDAO)</span>
<span class="nc" id="L475">          .getFromResultSet(preparedStatement.getResultSet());</span>
<span class="nc" id="L476">      return dbRule;</span>
<span class="nc" id="L477">    } catch (SQLException e) {</span>
<span class="nc" id="L478">      DbSession.error(e);</span>
<span class="nc" id="L479">      throw new WaarpDatabaseSqlException(&quot;Getting values in error&quot;, e);</span>
<span class="nc" id="L480">    } catch (DAOConnectionException e) {</span>
<span class="nc" id="L481">      throw new WaarpDatabaseSqlException(&quot;Getting values in error&quot;, e);</span>
    } finally {
<span class="nc" id="L483">      DAOFactory.closeDAO(ruleDAO);</span>
    }
  }

  /**
   * @return the DbPreparedStatement for getting Updated Object
   *
   * @throws WaarpDatabaseNoConnectionException
   * @throws WaarpDatabaseSqlException
   */
  public static DbRule[] getUpdatedPrepareStament()
      throws WaarpDatabaseNoConnectionException, WaarpDatabaseSqlException {
<span class="nc" id="L495">    final List&lt;Filter&gt; filters = new ArrayList&lt;Filter&gt;(1);</span>
<span class="nc" id="L496">    filters.add(new Filter(DBRuleDAO.UPDATED_INFO_FIELD, &quot;=&quot;,</span>
<span class="nc" id="L497">                           org.waarp.openr66.pojo.UpdatedInfo</span>
<span class="nc" id="L498">                               .fromLegacy(UpdatedInfo.TOSUBMIT).ordinal()));</span>
<span class="nc" id="L499">    RuleDAO ruleAccess = null;</span>
    List&lt;Rule&gt; rules;
    try {
<span class="nc" id="L502">      ruleAccess = DAOFactory.getInstance().getRuleDAO();</span>
<span class="nc" id="L503">      rules = ruleAccess.find(filters);</span>
<span class="nc" id="L504">    } catch (final DAOConnectionException e) {</span>
<span class="nc" id="L505">      throw new WaarpDatabaseNoConnectionException(e);</span>
    } finally {
<span class="nc" id="L507">      DAOFactory.closeDAO(ruleAccess);</span>
    }
<span class="nc" id="L509">    final DbRule[] res = new DbRule[rules.size()];</span>
<span class="nc" id="L510">    int i = 0;</span>
<span class="nc bnc" id="L511" title="All 2 branches missed.">    for (final Rule rule : rules) {</span>
<span class="nc" id="L512">      res[i] = new DbRule(rule);</span>
<span class="nc" id="L513">      i++;</span>
<span class="nc" id="L514">    }</span>
<span class="nc" id="L515">    return res;</span>
  }

  @Override
  public void changeUpdatedInfo(UpdatedInfo info) {
<span class="nc" id="L520">    pojo.setUpdatedInfo(org.waarp.openr66.pojo.UpdatedInfo.fromLegacy(info));</span>
<span class="nc" id="L521">  }</span>

  /**
   * Get Ids from String. If it is not ok, then it sets the default values and
   * return False, else returns True.
   *
   * @param idsref
   *
   * @return True if ok, else False (default values).
   */
  private String[] getIdsRule(String idsref) {
<span class="nc bnc" id="L532" title="All 2 branches missed.">    if (idsref == null) {</span>
      // No ids so setting to the default!
<span class="nc" id="L534">      return STRING_0_LENGTH;</span>
    }
<span class="nc" id="L536">    final StringReader reader = new StringReader(idsref);</span>
    Document document;
    try {
<span class="nc" id="L539">      document = new SAXReader().read(reader);</span>
<span class="nc" id="L540">      final XmlValue[] values =</span>
<span class="nc" id="L541">          XmlUtil.read(document, RuleFileBasedConfiguration.hostsDecls);</span>
<span class="nc" id="L542">      return RuleFileBasedConfiguration.getHostIds(values[0]);</span>
<span class="nc" id="L543">    } catch (final DocumentException e) {</span>
<span class="nc" id="L544">      logger.warn(&quot;Unable to read the ids for Rule: &quot; + idsref, e);</span>
      // No ids so setting to the default!
<span class="nc" id="L546">      return STRING_0_LENGTH;</span>
    } finally {
<span class="nc" id="L548">      FileUtils.close(reader);</span>
    }
  }

  /**
   * Get Tasks from String. If it is not ok, then it sets the default values
   * and
   * return new array of Tasks or
   * null if in error.
   *
   * @param tasks
   *
   * @return Array of tasks or empty array if in error.
   */
  private String[][] getTasksRule(String tasks) {
<span class="nc bnc" id="L563" title="All 2 branches missed.">    if (tasks == null) {</span>
      // No tasks so setting to the default!
<span class="nc" id="L565">      return STRINGS_0_0_LENGTH;</span>
    }
<span class="nc" id="L567">    final StringReader reader = new StringReader(tasks);</span>
    Document document;
    try {
<span class="nc" id="L570">      document = new SAXReader().read(reader);</span>
<span class="nc" id="L571">    } catch (final DocumentException e) {</span>
<span class="nc" id="L572">      logger.info(&quot;Unable to read the tasks for Rule: &quot; + tasks, e);</span>
      // No tasks so setting to the default!
<span class="nc" id="L574">      FileUtils.close(reader);</span>
<span class="nc" id="L575">      return STRINGS_0_0_LENGTH;</span>
<span class="nc" id="L576">    }</span>
<span class="nc" id="L577">    final XmlValue[] values =</span>
<span class="nc" id="L578">        XmlUtil.read(document, RuleFileBasedConfiguration.tasksDecl);</span>
<span class="nc" id="L579">    final String[][] result =</span>
<span class="nc" id="L580">        RuleFileBasedConfiguration.getTasksRule(values[0]);</span>
<span class="nc" id="L581">    FileUtils.close(reader);</span>
<span class="nc" id="L582">    return result;</span>
  }

  /**
   * Get the full path from RecvPath (used only in copy MODETRANS)
   *
   * @param filename
   *
   * @return the full String path
   *
   * @throws OpenR66ProtocolSystemException
   */
  public String setRecvPath(String filename)
      throws OpenR66ProtocolSystemException {
<span class="nc bnc" id="L596" title="All 4 branches missed.">    if (pojo.getRecvPath() != null &amp;&amp; !pojo.getRecvPath().isEmpty()) {</span>
<span class="nc" id="L597">      return pojo.getRecvPath() + DirInterface.SEPARATOR + filename;</span>
    }
<span class="nc" id="L599">    return Configuration.configuration.getInPath() + DirInterface.SEPARATOR +</span>
           filename;
  }

  /**
   * Get the full path from sendPath
   *
   * @param filename
   *
   * @return the full String path
   *
   * @throws OpenR66ProtocolSystemException
   */
  public String setSendPath(String filename)
      throws OpenR66ProtocolSystemException {
<span class="nc bnc" id="L614" title="All 2 branches missed.">    if (pojo.getSendPath() != null) {</span>
<span class="nc" id="L615">      final File file = new File(filename);</span>
<span class="nc" id="L616">      final String basename = file.getName();</span>
<span class="nc" id="L617">      return pojo.getSendPath() + DirInterface.SEPARATOR + basename;</span>
    }
<span class="nc" id="L619">    return Configuration.configuration.getOutPath() + DirInterface.SEPARATOR +</span>
           filename;
  }

  /**
   * Get the full path from archivePath
   *
   * @param filename
   *
   * @return the full String path
   *
   * @throws OpenR66ProtocolSystemException
   */
  public String setArchivePath(String filename)
      throws OpenR66ProtocolSystemException {
<span class="nc bnc" id="L634" title="All 2 branches missed.">    if (pojo.getArchivePath() != null) {</span>
<span class="nc" id="L635">      return pojo.getArchivePath() + DirInterface.SEPARATOR + filename;</span>
    }
<span class="nc" id="L637">    return Configuration.configuration.getArchivePath() +</span>
           DirInterface.SEPARATOR + filename;
  }

  /**
   * Get the full path from workPath
   *
   * @param filename
   *
   * @return the full String path
   *
   * @throws OpenR66ProtocolSystemException
   */
  public String setWorkingPath(String filename)
      throws OpenR66ProtocolSystemException {
<span class="nc bnc" id="L652" title="All 2 branches missed.">    if (pojo.getWorkPath() != null) {</span>
<span class="nc" id="L653">      return pojo.getWorkPath() + DirInterface.SEPARATOR + filename +</span>
             Configuration.EXT_R66;
    }
<span class="nc" id="L656">    return Configuration.configuration.getWorkingPath() +</span>
           DirInterface.SEPARATOR + filename;
  }

  /**
   * Check if the given hostTo is in the allowed list
   *
   * @param hostId
   *
   * @return True if allow, else False
   */
  public boolean checkHostAllow(String hostId) {
<span class="nc bnc" id="L668" title="All 4 branches missed.">    if (getIdsArray() == null || getIdsArray().length == 0) {</span>
<span class="nc" id="L669">      return true; // always true in this case</span>
    }
<span class="nc bnc" id="L671" title="All 2 branches missed.">    for (final String element : getIdsArray()) {</span>
<span class="nc bnc" id="L672" title="All 2 branches missed.">      if (element.equalsIgnoreCase(hostId)) {</span>
<span class="nc" id="L673">        return true;</span>
      }
    }
<span class="nc" id="L676">    return false;</span>
  }

  /**
   * @return True if this rule is adapted for SENDMODE
   */
  public boolean isSendMode() {
<span class="nc bnc" id="L683" title="All 2 branches missed.">    return !RequestPacket.isRecvMode(getMode());</span>
  }

  /**
   * @return True if this rule is adapted for RECVMODE
   */
  public boolean isRecvMode() {
<span class="nc" id="L690">    return RequestPacket.isRecvMode(getMode());</span>
  }

  /**
   * Object to String
   *
   * @return the string that displays this object
   *
   * @see Object#toString()
   */
  @Override
  public String toString() {
<span class="nc" id="L702">    return &quot;Rule Name:&quot; + getIdRule() + &quot; IDS:&quot; + pojo.getXMLHostids() +</span>
<span class="nc" id="L703">           &quot; MODETRANS: &quot; + RequestPacket.TRANSFERMODE.values()[getMode()] +</span>
<span class="nc" id="L704">           &quot; RECV:&quot; + getRecvPath() + &quot; SEND:&quot; + getSendPath() + &quot; ARCHIVE:&quot; +</span>
<span class="nc" id="L705">           getArchivePath() + &quot; WORK:&quot; + getWorkPath() + &quot; RPRET:{&quot; +</span>
<span class="nc" id="L706">           pojo.getXMLRPreTasks().replace('\n', ' ') + &quot;} RPOST:{&quot; +</span>
<span class="nc" id="L707">           pojo.getXMLRPostTasks().replace('\n', ' ') + &quot;} RERROR:{&quot; +</span>
<span class="nc" id="L708">           pojo.getXMLRErrorTasks().replace('\n', ' ') + &quot;} SPRET:{&quot; +</span>
<span class="nc" id="L709">           pojo.getXMLSPreTasks().replace('\n', ' ') + &quot;} SPOST:{&quot; +</span>
<span class="nc" id="L710">           pojo.getXMLSPostTasks().replace('\n', ' ') + &quot;} SERROR:{&quot; +</span>
<span class="nc" id="L711">           pojo.getXMLSErrorTasks().replace('\n', ' ') + '}';</span>
  }

  /**
   * @param isSender
   * @param step
   *
   * @return a string that prints (debug) the tasks to execute
   */
  public String printTasks(boolean isSender, TASKSTEP step) {
<span class="nc bnc" id="L721" title="All 2 branches missed.">    if (isSender) {</span>
<span class="nc bnc" id="L722" title="All 4 branches missed.">      switch (step) {</span>
        case PRETASK:
<span class="nc" id="L724">          return &quot;S:{&quot; + pojo.getXMLRPreTasks().replace('\n', ' ') + '}';</span>
        case POSTTASK:
<span class="nc" id="L726">          return &quot;S:{&quot; + pojo.getXMLRPostTasks().replace('\n', ' ') + '}';</span>
        case ERRORTASK:
<span class="nc" id="L728">          return &quot;S:{&quot; + pojo.getXMLRErrorTasks().replace('\n', ' ') + '}';</span>
        default:
<span class="nc" id="L730">          return &quot;S:{no task}&quot;;</span>
      }
    } else {
<span class="nc bnc" id="L733" title="All 4 branches missed.">      switch (step) {</span>
        case PRETASK:
<span class="nc" id="L735">          return &quot;R:{&quot; + pojo.getXMLSPreTasks().replace('\n', ' ') + '}';</span>
        case POSTTASK:
<span class="nc" id="L737">          return &quot;R:{&quot; + pojo.getXMLSPostTasks().replace('\n', ' ') + '}';</span>
        case ERRORTASK:
<span class="nc" id="L739">          return &quot;R:{&quot; + pojo.getXMLSErrorTasks().replace('\n', ' ') + '}';</span>
        default:
<span class="nc" id="L741">          return &quot;R:{no task}&quot;;</span>
      }
    }
  }

  /**
   * Object to String
   *
   * @return the string that displays this object
   *
   * @see Object#toString()
   */
  public String toShortString() {
<span class="nc" id="L754">    return &quot;Rule Name:&quot; + getIdRule() + &quot; MODETRANS: &quot; +</span>
<span class="nc" id="L755">           RequestPacket.TRANSFERMODE.values()[getMode()];</span>
  }

  /**
   * @param session
   * @param rule
   * @param mode
   *
   * @return the DbPreparedStatement according to the filter
   *
   * @throws WaarpDatabaseNoConnectionException
   * @throws WaarpDatabaseSqlException
   */
  public static DbPreparedStatement getFilterPrepareStament(DbSession session,
                                                            String rule,
                                                            int mode)
      throws WaarpDatabaseNoConnectionException, WaarpDatabaseSqlException {
<span class="nc" id="L772">    final DbPreparedStatement preparedStatement =</span>
        new DbPreparedStatement(session);
<span class="nc" id="L774">    final String request = &quot;SELECT &quot; + selectAllFields + &quot; FROM &quot; + table;</span>
<span class="nc" id="L775">    String condition = null;</span>
<span class="nc bnc" id="L776" title="All 2 branches missed.">    if (rule != null) {</span>
<span class="nc" id="L777">      condition = &quot; WHERE &quot; + Columns.IDRULE.name() + &quot; LIKE '%&quot; + rule + &quot;%' &quot;;</span>
    }
<span class="nc bnc" id="L779" title="All 2 branches missed.">    if (mode &gt;= 0) {</span>
<span class="nc bnc" id="L780" title="All 2 branches missed.">      if (condition != null) {</span>
<span class="nc" id="L781">        condition += &quot; AND &quot;;</span>
      } else {
<span class="nc" id="L783">        condition = &quot; WHERE &quot;;</span>
      }
<span class="nc" id="L785">      condition += Columns.MODETRANS.name() + &quot; = ?&quot;;</span>
    } else {
<span class="nc" id="L787">      condition = &quot;&quot;;</span>
    }
<span class="nc" id="L789">    preparedStatement.createPrepareStatement(</span>
<span class="nc" id="L790">        request + condition + &quot; ORDER BY &quot; + Columns.IDRULE.name());</span>
<span class="nc bnc" id="L791" title="All 2 branches missed.">    if (mode &gt;= 0) {</span>
      try {
<span class="nc" id="L793">        preparedStatement.getPreparedStatement().setInt(1, mode);</span>
<span class="nc" id="L794">      } catch (final SQLException e) {</span>
<span class="nc" id="L795">        preparedStatement.realClose();</span>
<span class="nc" id="L796">        throw new WaarpDatabaseSqlException(e);</span>
<span class="nc" id="L797">      }</span>
    }
<span class="nc" id="L799">    return preparedStatement;</span>
  }

  /**
   * Write selected DbRule to a Json String
   *
   * @param preparedStatement
   *
   * @return the associated Json String
   *
   * @throws WaarpDatabaseNoConnectionException
   * @throws WaarpDatabaseSqlException
   * @throws OpenR66ProtocolBusinessException
   */
  public static String getJson(DbPreparedStatement preparedStatement, int limit)
      throws WaarpDatabaseNoConnectionException, WaarpDatabaseSqlException,
             OpenR66ProtocolBusinessException {
<span class="nc" id="L816">    final ArrayNode arrayNode = JsonHandler.createArrayNode();</span>
    try {
<span class="nc" id="L818">      preparedStatement.executeQuery();</span>
<span class="nc" id="L819">      int nb = 0;</span>
<span class="nc bnc" id="L820" title="All 2 branches missed.">      while (preparedStatement.getNext()) {</span>
<span class="nc" id="L821">        final DbRule rule = getFromStatement(preparedStatement);</span>
<span class="nc" id="L822">        final ObjectNode node = rule.getInternalJson();</span>
<span class="nc" id="L823">        arrayNode.add(node);</span>
<span class="nc" id="L824">        nb++;</span>
<span class="nc bnc" id="L825" title="All 2 branches missed.">        if (nb &gt;= limit) {</span>
<span class="nc" id="L826">          break;</span>
        }
<span class="nc" id="L828">      }</span>
    } finally {
<span class="nc" id="L830">      preparedStatement.realClose();</span>
    }
    // \n is not correctly parsed within HTML so put double \\n in fine
<span class="nc" id="L833">    return WaarpStringUtils.cleanJsonForHtml(arrayNode.toString());</span>
  }

  private ObjectNode getInternalJson() {
<span class="nc" id="L837">    final ObjectNode node = getJson();</span>
<span class="nc bnc" id="L838" title="All 2 branches missed.">    if (pojo.getHostids().isEmpty()) {</span>
<span class="nc" id="L839">      node.put(Columns.HOSTIDS.name(), &quot;&quot;);</span>
    }
<span class="nc bnc" id="L841" title="All 2 branches missed.">    if (pojo.getRecvPath() == null) {</span>
<span class="nc" id="L842">      node.put(Columns.RECVPATH.name(), &quot;&quot;);</span>
    }
<span class="nc bnc" id="L844" title="All 2 branches missed.">    if (pojo.getSendPath() == null) {</span>
<span class="nc" id="L845">      node.put(Columns.SENDPATH.name(), &quot;&quot;);</span>
    }
<span class="nc bnc" id="L847" title="All 2 branches missed.">    if (pojo.getArchivePath() == null) {</span>
<span class="nc" id="L848">      node.put(Columns.ARCHIVEPATH.name(), &quot;&quot;);</span>
    }
<span class="nc bnc" id="L850" title="All 2 branches missed.">    if (pojo.getWorkPath() == null) {</span>
<span class="nc" id="L851">      node.put(Columns.WORKPATH.name(), &quot;&quot;);</span>
    }
<span class="nc bnc" id="L853" title="All 2 branches missed.">    if (pojo.getRPreTasks().isEmpty()) {</span>
<span class="nc" id="L854">      node.put(Columns.RPRETASKS.name(), &quot;&quot;);</span>
    }
<span class="nc bnc" id="L856" title="All 2 branches missed.">    if (pojo.getRPostTasks().isEmpty()) {</span>
<span class="nc" id="L857">      node.put(Columns.RPOSTTASKS.name(), &quot;&quot;);</span>
    }
<span class="nc bnc" id="L859" title="All 2 branches missed.">    if (pojo.getRErrorTasks().isEmpty()) {</span>
<span class="nc" id="L860">      node.put(Columns.RERRORTASKS.name(), &quot;&quot;);</span>
    }
<span class="nc bnc" id="L862" title="All 2 branches missed.">    if (pojo.getSPreTasks().isEmpty()) {</span>
<span class="nc" id="L863">      node.put(Columns.SPRETASKS.name(), &quot;&quot;);</span>
    }
<span class="nc bnc" id="L865" title="All 2 branches missed.">    if (pojo.getSPostTasks().isEmpty()) {</span>
<span class="nc" id="L866">      node.put(Columns.SPOSTTASKS.name(), &quot;&quot;);</span>
    }
<span class="nc bnc" id="L868" title="All 2 branches missed.">    if (pojo.getSErrorTasks().isEmpty()) {</span>
<span class="nc" id="L869">      node.put(Columns.SERRORTASKS.name(), &quot;&quot;);</span>
    }
<span class="nc" id="L871">    return node;</span>
  }

  /**
   * @return the Json string for this
   */
  public String getJsonAsString() {
<span class="nc" id="L878">    final ObjectNode node = getInternalJson();</span>
<span class="nc" id="L879">    return JsonHandler.writeAsString(node).replaceAll(&quot;([^\\\\])\\\\n&quot;, &quot;$1&quot;)</span>
<span class="nc" id="L880">                      .replaceAll(&quot;([^\\\\])\\\\r&quot;, &quot;$1&quot;)</span>
<span class="nc" id="L881">                      .replace(&quot;\\\\&quot;, &quot;\\\\\\\\&quot;);</span>
  }

  /**
   * @param session
   * @param body
   *
   * @return the runner in Html format specified by body by replacing all
   *     instance of fields
   */
  public String toSpecializedHtml(R66Session session, String body) {
<span class="nc" id="L892">    final StringBuilder builder = new StringBuilder(body);</span>
<span class="nc" id="L893">    WaarpStringUtils.replace(builder, &quot;XXXRULEXXX&quot;, getIdRule());</span>
<span class="nc" id="L894">    WaarpStringUtils.replace(builder, &quot;XXXIDSXXX&quot;,</span>
<span class="nc bnc" id="L895" title="All 2 branches missed.">                             pojo.getXMLHostids() == null? &quot;&quot; :</span>
<span class="nc" id="L896">                                 pojo.getXMLHostids());</span>
<span class="nc bnc" id="L897" title="All 2 branches missed.">    if (getMode() == RequestPacket.TRANSFERMODE.RECVMODE.ordinal()) {</span>
<span class="nc" id="L898">      WaarpStringUtils.replace(builder, &quot;XXXRECVXXX&quot;, &quot;checked&quot;);</span>
<span class="nc bnc" id="L899" title="All 2 branches missed.">    } else if (getMode() == RequestPacket.TRANSFERMODE.SENDMODE.ordinal()) {</span>
<span class="nc" id="L900">      WaarpStringUtils.replace(builder, &quot;XXXSENDXXX&quot;, &quot;checked&quot;);</span>
<span class="nc bnc" id="L901" title="All 2 branches missed.">    } else if (getMode() == RequestPacket.TRANSFERMODE.RECVMD5MODE.ordinal()) {</span>
<span class="nc" id="L902">      WaarpStringUtils.replace(builder, &quot;XXXRECVMXXX&quot;, &quot;checked&quot;);</span>
<span class="nc bnc" id="L903" title="All 2 branches missed.">    } else if (getMode() == RequestPacket.TRANSFERMODE.SENDMD5MODE.ordinal()) {</span>
<span class="nc" id="L904">      WaarpStringUtils.replace(builder, &quot;XXXSENDMXXX&quot;, &quot;checked&quot;);</span>
<span class="nc" id="L905">    } else if (getMode() ==</span>
<span class="nc bnc" id="L906" title="All 2 branches missed.">               RequestPacket.TRANSFERMODE.RECVTHROUGHMODE.ordinal()) {</span>
<span class="nc" id="L907">      WaarpStringUtils.replace(builder, &quot;XXXRECVTXXX&quot;, &quot;checked&quot;);</span>
<span class="nc" id="L908">    } else if (getMode() ==</span>
<span class="nc bnc" id="L909" title="All 2 branches missed.">               RequestPacket.TRANSFERMODE.SENDTHROUGHMODE.ordinal()) {</span>
<span class="nc" id="L910">      WaarpStringUtils.replace(builder, &quot;XXXSENDTXXX&quot;, &quot;checked&quot;);</span>
<span class="nc" id="L911">    } else if (getMode() ==</span>
<span class="nc bnc" id="L912" title="All 2 branches missed.">               RequestPacket.TRANSFERMODE.RECVMD5THROUGHMODE.ordinal()) {</span>
<span class="nc" id="L913">      WaarpStringUtils.replace(builder, &quot;XXXRECVMTXXX&quot;, &quot;checked&quot;);</span>
<span class="nc" id="L914">    } else if (getMode() ==</span>
<span class="nc bnc" id="L915" title="All 2 branches missed.">               RequestPacket.TRANSFERMODE.SENDMD5THROUGHMODE.ordinal()) {</span>
<span class="nc" id="L916">      WaarpStringUtils.replace(builder, &quot;XXXSENDMTXXX&quot;, &quot;checked&quot;);</span>
    }
<span class="nc" id="L918">    WaarpStringUtils.replace(builder, &quot;XXXRPXXX&quot;,</span>
<span class="nc bnc" id="L919" title="All 2 branches missed.">                             pojo.getRecvPath() == null? &quot;&quot; :</span>
<span class="nc" id="L920">                                 pojo.getRecvPath());</span>
<span class="nc" id="L921">    WaarpStringUtils.replace(builder, &quot;XXXSPXXX&quot;,</span>
<span class="nc bnc" id="L922" title="All 2 branches missed.">                             pojo.getSendPath() == null? &quot;&quot; :</span>
<span class="nc" id="L923">                                 pojo.getSendPath());</span>
<span class="nc" id="L924">    WaarpStringUtils.replace(builder, &quot;XXXAPXXX&quot;,</span>
<span class="nc bnc" id="L925" title="All 2 branches missed.">                             pojo.getArchivePath() == null? &quot;&quot; :</span>
<span class="nc" id="L926">                                 pojo.getArchivePath());</span>
<span class="nc" id="L927">    WaarpStringUtils.replace(builder, &quot;XXXWPXXX&quot;,</span>
<span class="nc bnc" id="L928" title="All 2 branches missed.">                             pojo.getWorkPath() == null? &quot;&quot; :</span>
<span class="nc" id="L929">                                 pojo.getWorkPath());</span>
<span class="nc" id="L930">    WaarpStringUtils.replace(builder, &quot;XXXRPTXXX&quot;,</span>
<span class="nc bnc" id="L931" title="All 2 branches missed.">                             pojo.getXMLRPreTasks() == null? &quot;&quot; :</span>
<span class="nc" id="L932">                                 pojo.getXMLRPreTasks());</span>
<span class="nc" id="L933">    WaarpStringUtils.replace(builder, &quot;XXXRSTXXX&quot;,</span>
<span class="nc bnc" id="L934" title="All 2 branches missed.">                             pojo.getXMLRPostTasks() == null? &quot;&quot; :</span>
<span class="nc" id="L935">                                 pojo.getXMLRPostTasks());</span>
<span class="nc" id="L936">    WaarpStringUtils.replace(builder, &quot;XXXRETXXX&quot;,</span>
<span class="nc bnc" id="L937" title="All 2 branches missed.">                             pojo.getXMLRErrorTasks() == null? &quot;&quot; :</span>
<span class="nc" id="L938">                                 pojo.getXMLRErrorTasks());</span>
<span class="nc" id="L939">    WaarpStringUtils.replace(builder, &quot;XXXSPTXXX&quot;,</span>
<span class="nc bnc" id="L940" title="All 2 branches missed.">                             pojo.getXMLSPreTasks() == null? &quot;&quot; :</span>
<span class="nc" id="L941">                                 pojo.getXMLSPreTasks());</span>
<span class="nc" id="L942">    WaarpStringUtils.replace(builder, &quot;XXXSSTXXX&quot;,</span>
<span class="nc bnc" id="L943" title="All 2 branches missed.">                             pojo.getXMLSPostTasks() == null? &quot;&quot; :</span>
<span class="nc" id="L944">                                 pojo.getXMLSPostTasks());</span>
<span class="nc" id="L945">    WaarpStringUtils.replace(builder, &quot;XXXSETXXX&quot;,</span>
<span class="nc bnc" id="L946" title="All 2 branches missed.">                             pojo.getXMLSErrorTasks() == null? &quot;&quot; :</span>
<span class="nc" id="L947">                                 pojo.getXMLSErrorTasks());</span>
<span class="nc" id="L948">    return builder.toString();</span>
  }

  /**
   * @return the recvPath
   */
  public String getRecvPath() {
<span class="nc bnc" id="L955" title="All 4 branches missed.">    if (getRuleRecvPath() == null || getRuleRecvPath().trim().isEmpty()) {</span>
<span class="nc" id="L956">      return Configuration.configuration.getInPath();</span>
    }
<span class="nc" id="L958">    return getRuleRecvPath();</span>
  }

  /**
   * @return the sendPath
   */
  public String getSendPath() {
<span class="nc bnc" id="L965" title="All 4 branches missed.">    if (getRuleSendPath() == null || getRuleSendPath().trim().isEmpty()) {</span>
<span class="nc" id="L966">      return Configuration.configuration.getOutPath();</span>
    }
<span class="nc" id="L968">    return getRuleSendPath();</span>
  }

  /**
   * @return the archivePath
   */
  public String getArchivePath() {
<span class="nc bnc" id="L975" title="All 4 branches missed.">    if (getRuleArchivePath() == null || getRuleArchivePath().trim().isEmpty()) {</span>
<span class="nc" id="L976">      return Configuration.configuration.getArchivePath();</span>
    }
<span class="nc" id="L978">    return getRuleArchivePath();</span>
  }

  /**
   * @return the workPath
   */
  public String getWorkPath() {
<span class="nc bnc" id="L985" title="All 4 branches missed.">    if (getRuleWorkPath() == null || getRuleWorkPath().trim().isEmpty()) {</span>
<span class="nc" id="L986">      return Configuration.configuration.getWorkingPath();</span>
    }
<span class="nc" id="L988">    return getRuleWorkPath();</span>
  }

  /**
   * @return the Rule recvPath
   */
  public String getRuleRecvPath() {
<span class="nc" id="L995">    return pojo.getRecvPath();</span>
  }

  /**
   * @return the Rule sendPath
   */
  public String getRuleSendPath() {
<span class="nc" id="L1002">    return pojo.getSendPath();</span>
  }

  /**
   * @return the Rule archivePath
   */
  public String getRuleArchivePath() {
<span class="nc" id="L1009">    return pojo.getArchivePath();</span>
  }

  /**
   * @return the Rule workPath
   */
  public String getRuleWorkPath() {
<span class="nc" id="L1016">    return pojo.getWorkPath();</span>
  }

  /**
   * @return the idRule
   */
  public String getIdRule() {
<span class="nc" id="L1023">    return pojo.getName();</span>
  }

  /**
   * @return the mode
   */
  public int getMode() {
<span class="nc" id="L1030">    return pojo.getMode();</span>
  }

  /**
   * @return the idsArray
   */
  public String[] getIdsArray() {
<span class="nc" id="L1037">    return pojo.getHostids().toArray(STRING_0_LENGTH);</span>
  }

  /**
   * @return the rpreTasksArray
   */
  public String[][] getRpreTasksArray() {
<span class="nc" id="L1044">    return toLegacyTasks(pojo.getRPreTasks());</span>
  }

  /**
   * @return the rpostTasksArray
   */
  public String[][] getRpostTasksArray() {
<span class="nc" id="L1051">    return toLegacyTasks(pojo.getRPostTasks());</span>
  }

  /**
   * @return the rerrorTasksArray
   */
  public String[][] getRerrorTasksArray() {
<span class="nc" id="L1058">    return toLegacyTasks(pojo.getRErrorTasks());</span>
  }

  /**
   * @return the spreTasksArray
   */
  public String[][] getSpreTasksArray() {
<span class="nc" id="L1065">    return toLegacyTasks(pojo.getSPreTasks());</span>
  }

  /**
   * @return the spostTasksArray
   */
  public String[][] getSpostTasksArray() {
<span class="nc" id="L1072">    return toLegacyTasks(pojo.getSPostTasks());</span>
  }

  /**
   * @return the serrorTasksArray
   */
  public String[][] getSerrorTasksArray() {
<span class="nc" id="L1079">    return toLegacyTasks(pojo.getSErrorTasks());</span>
  }

  private List&lt;RuleTask&gt; fromLegacyTasks(String[][] tasks) {
<span class="nc" id="L1083">    final int size = tasks.length;</span>
<span class="nc" id="L1084">    final List&lt;RuleTask&gt; res = new ArrayList&lt;RuleTask&gt;(size);</span>
<span class="nc bnc" id="L1085" title="All 2 branches missed.">    for (final String[] task : tasks) {</span>
<span class="nc" id="L1086">      res.add(new RuleTask(task[0], task[1], Integer.parseInt(task[2])));</span>
    }
<span class="nc" id="L1088">    return res;</span>
  }

  private String[][] toLegacyTasks(List&lt;RuleTask&gt; tasks) {
<span class="nc" id="L1092">    final int size = tasks.size();</span>
<span class="nc" id="L1093">    final String[][] res = new String[size][];</span>
<span class="nc" id="L1094">    int i = 0;</span>
<span class="nc bnc" id="L1095" title="All 2 branches missed.">    for (final RuleTask task : tasks) {</span>
<span class="nc" id="L1096">      res[i] = new String[3];</span>
<span class="nc" id="L1097">      res[i][0] = task.getType();</span>
<span class="nc" id="L1098">      res[i][1] = task.getPath();</span>
<span class="nc" id="L1099">      res[i][2] = String.valueOf(task.getDelay());</span>
<span class="nc" id="L1100">      i++;</span>
<span class="nc" id="L1101">    }</span>
<span class="nc" id="L1102">    return res;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>